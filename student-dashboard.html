<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gradelytics â€” Student Dashboard</title>
<style>
  * { box-sizing: border-box; font-family: Poppins, system-ui, Arial; }
  body { margin: 0; display: flex; height: 100vh; background: #f8fafc; }

  .sidebar {
    width: 220px; background: #1e3a8a; color: #fff; padding: 18px;
    display: flex; flex-direction: column;
  }
  .sidebar h2 { color: #facc15; text-align: center; margin-bottom: 18px; }
  .sidebar button {
    background: none; border: none; color: #fff; padding: 10px;
    text-align: left; border-radius: 8px; margin-bottom: 8px; cursor: pointer;
  }
  .sidebar button.active, .sidebar button:hover {
    background: #facc15; color: #1e3a8a; font-weight: 700;
  }
  .sidebar .logout {
    margin-top: auto; background: #facc15; color: #1e3a8a;
    padding: 10px; border-radius: 8px; border: none; cursor: pointer;
  }

  .main {
    flex: 1; padding: 16px; overflow: auto;
    background-image: url(assets/ustp.jpeg);
    background-repeat: no-repeat;
    background-size: cover;
  }

  header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px; background: #fff; padding: 12px; border-radius: 8px;
  }
  header h1 { margin: 0; color: #1e3a8a; }

  .notif {
    position: relative; cursor: pointer; font-size: 20px;
  }
  .notif .badge {
    position: absolute; top: -6px; right: -6px;
    background: #ef4444; color: #fff;
    border-radius: 12px; padding: 2px 6px; font-size: 12px;
  }

  .notif-popup {
    display: none; position: absolute; top: 30px; right: 0;
    background: #fff; color: #000; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    width: 220px; z-index: 10; padding: 8px;
  }
  .notif-popup p {
    margin: 0; padding: 6px; border-bottom: 1px solid #eee; font-size: 14px;
  }
  .notif-popup p:last-child { border-bottom: none; }

  .panel {
    background: rgba(255,255,255,0.9); padding: 12px;
    border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .two-col { display: flex; gap: 12px; }
  .left { width: 260px; }

  .subjectBtn {
    display: block; width: 100%; padding: 8px; text-align: left;
    border-radius: 6px; border: none; background: #1e3a8a;
    color: #fff; margin-bottom: 6px; cursor: pointer;
  }

  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
  th { background: #facc15; color: #1e3a8a; }
  .small { font-size: 13px; color: #444; }
  .complaintBtn {
    background: #ef4444; color: #fff; border: none;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
  }
</style>
</head>
<body>

<div class="sidebar">
  <h2>STUDENT PANEL</h2>
  <button id="nav-dashboard" class="active">Dashboard</button>
  <button id="nav-lacking">View Lacking</button>
  <button id="nav-grades">View Grades</button>
  <button id="nav-tasks">View Performance Task</button>
  <button class="logout" id="btnLogout">Logout</button>
</div>

<div class="main">
  <header>
    <div>
      <h1 id="welcome">Welcome, Student!</h1>
      <div class="small" id="studentMeta"></div>
    </div>
    <div style="position: relative;">
      <div class="notif" id="notifBell">ðŸ””
        <span class="badge" id="notifCount" style="display:none">0</span>
        <div class="notif-popup" id="notifPopup"></div>
      </div>
    </div>
  </header>

  <div id="section-dashboard" class="panel">
    <h2>Dashboard</h2>
    <div id="dashContent" class="small">Your academic overview appears here.</div>
  </div>

  <div id="section-lacking" class="panel" style="display:none">
    <h2>Your Lacking Items</h2>
    <div id="lackingList"></div>
    <div style="margin-top:15px;">
      <button class="complaintBtn" id="btnComplaint">Submit a Complaint</button>
    </div>
  </div>

  <div id="section-grades" class="panel" style="display:none">
    <div class="two-col">
      <div class="left">
        <h3>Subjects</h3>
        <div id="subjectList"></div>
      </div>
      <div style="flex:1">
        <h3 id="gradeTitle">Grade Sheet</h3>
        <div id="gradeArea"></div>
      </div>
    </div>
  </div>

  <div id="section-tasks" class="panel" style="display:none">
    <h2>Performance Tasks</h2>
    <div id="taskList"></div>
  </div>
</div>

<script>
const USERS_KEY = 'users';
const FACULTY_GRADES_KEY = 'facultyGrades';
const STUDENT_GRADES_KEY = 'studentGrades';
const COMPLAINTS_KEY = 'complaints';
const LACKING_KEY = 'lackingTasks';
const TASKS_KEY = 'performanceTasks';
const ACTIVE_KEY = 'activeUser';

let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
let complaints = JSON.parse(localStorage.getItem(COMPLAINTS_KEY)) || [];
let lacking = JSON.parse(localStorage.getItem(LACKING_KEY)) || [];
let tasks = JSON.parse(localStorage.getItem(TASKS_KEY)) || [];
let studentGrades = JSON.parse(localStorage.getItem(STUDENT_GRADES_KEY)) || {};
const activeUser = JSON.parse(localStorage.getItem(ACTIVE_KEY));

if (!activeUser || activeUser.role !== 'student') {
  alert('Please login as student');
  window.location.href = 'login.html';
}

document.getElementById('welcome').textContent =
  `Welcome, ${activeUser.fname || ''} ${activeUser.lname || ''}! (${activeUser.id || ''})`;
document.getElementById('studentMeta').textContent =
  `${activeUser.course || ''} Â· ${activeUser.year || ''} Â· ${activeUser.section || ''}`;

const navIds = ['dashboard', 'lacking', 'grades', 'tasks'];
navIds.forEach(id =>
  document.getElementById('nav-' + id).addEventListener('click', () => showSection(id))
);
document.getElementById('btnLogout').addEventListener('click', () => {
  localStorage.removeItem(ACTIVE_KEY);
  window.location.href = 'login.html';
});
function showSection(s) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById('section-' + s).style.display = 'block';
  document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
  document.getElementById('nav-' + s).classList.add('active');
  if (s === 'grades') renderSubjects();
  if (s === 'lacking') renderLacking();
  if (s === 'tasks') renderTasks();
  updateNotif();
}

/* --- Notifications --- */
function updateNotif() {
  const sid = activeUser.id || activeUser.email;
  const newReplies = complaints.filter(c => c.studentId === sid && c.reply);
  const gradeUpdates = (studentGrades[sid] || []).length;
  const notifList = [...newReplies.map(r => `Reply from ${r.toName}`)];

  if (gradeUpdates > 0) notifList.push('Your grades were updated');

  const count = notifList.length;
  const notifCount = document.getElementById('notifCount');
  notifCount.style.display = count > 0 ? 'inline-block' : 'none';
  notifCount.textContent = count;

  const popup = document.getElementById('notifPopup');
  popup.innerHTML = notifList.length
    ? notifList.map(n => `<p>${n}</p>`).join('')
    : '<p>No new notifications.</p>';
}
document.getElementById('notifBell').addEventListener('click', () => {
  const popup = document.getElementById('notifPopup');
  popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
});

/* --- Subjects and Grades --- */
function renderSubjects() {
  const wrap = document.getElementById('subjectList');
  wrap.innerHTML = '';
  const facs = users.filter(u => u.role === 'faculty' && Array.isArray(u.assignedSubjects));
  const subjects = [];

  facs.forEach(f => {
    f.assignedSubjects.forEach(s => {
      if (
        (!s.course || s.course === activeUser.course) &&
        (!s.year || s.year === activeUser.year) &&
        (!s.section || s.section === activeUser.section)
      ) {
        subjects.push({ subject: s.subject, faculty: f.email });
      }
    });
  });

  const seen = new Set();
  const unique = [];
  subjects.forEach(s => { if (!seen.has(s.subject)) { seen.add(s.subject); unique.push(s); } });
  if (unique.length === 0) { wrap.innerHTML = '<p>No subjects assigned yet.</p>'; return; }

  unique.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'subjectBtn';
    btn.textContent = s.subject;
    btn.addEventListener('click', () => loadMySheet(s.subject));
    wrap.appendChild(btn);
  });
}
function loadMySheet(subject) {
  const wrap = document.getElementById('gradeArea');
  const sid = activeUser.id || activeUser.email;
  const map = JSON.parse(localStorage.getItem(STUDENT_GRADES_KEY)) || {};
  const entries = map[sid] || [];
  const my = entries.find(e => e.subject === subject);
  if (!my) { wrap.innerHTML = `<p>No grades yet for ${subject}.</p>`; return; }

  let html = `<h3>${subject}</h3><table><thead><tr><th>Component</th><th>Score</th></tr></thead><tbody>`;
  my.lec.forEach((v, i) => html += `<tr><td>Lecture ${i + 1}</td><td>${v || 'â€”'}</td></tr>`);
  my.lab.forEach((v, i) => html += `<tr><td>Lab ${i + 1}</td><td>${v || 'â€”'}</td></tr>`);
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

/* --- Lacking --- */
function renderLacking() {
  const my = lacking.filter(l => l.studentId === (activeUser.id || activeUser.email));
  const wrap = document.getElementById('lackingList');
  if (my.length === 0) wrap.innerHTML = '<p>No lacking items.</p>';
  else wrap.innerHTML = '<table><thead><tr><th>Item</th><th>Course</th><th>Date</th></tr></thead><tbody>' +
    my.map(m => `<tr><td>${m.item}</td><td>${m.course || ''}</td><td>${m.date}</td></tr>`).join('') +
    '</tbody></table>';
}
document.getElementById('btnComplaint').addEventListener('click', () => {
  alert('Redirecting to complaint form...');
  window.location.href = 'complaint.html';
});

/* --- Tasks --- */
function renderTasks() {
  const myTasks = tasks.filter(t => t.studentId === (activeUser.id || activeUser.email));
  const wrap = document.getElementById('taskList');
  if (myTasks.length === 0) wrap.innerHTML = '<p>No performance tasks.</p>';
  else wrap.innerHTML =
    '<table><thead><tr><th>Task</th><th>Score</th><th>Subject</th><th>Due Date</th></tr></thead><tbody>' +
    myTasks.map(t => `<tr><td>${t.task}</td><td>${t.score || ''}</td><td>${t.dueDate || ''}</td></tr>`).join('') +
    '</tbody></table>';
}

/* Init */
(function init() {
  renderSubjects();
  renderLacking();
  renderTasks();
  updateNotif();
})();
</script>
</body>
</html>
